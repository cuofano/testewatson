<%@ Page Language="C#" MasterPageFile="~/Views/Shared/Site.Master" Inherits="System.Web.Mvc.ViewPage" %>

<asp:Content ID="Content1" ContentPlaceHolderID="TitleContent" runat="server">
    Home Page
</asp:Content>

<asp:Content ID="Content2" ContentPlaceHolderID="MainContent" runat="server">
    <h2><%= Html.Encode(ViewData["Message"]) %></h2>
    <p>
        To learn more about ASP.NET MVC visit <a href="http://asp.net/mvc" title="ASP.NET MVC Website">http://asp.net/mvc</a>.
    </p>
    <script src="../../Scripts/jquery-1.6.1.min.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.jstree.js" type="text/javascript"></script>
    <script src="../../Scripts/MicrosoftAjax.js" type="text/javascript"></script>
    <script type="text/javascript" language="javascript">
    var GetStudentsURL = '<%= Url.Action("GetTreeData", "Home")%>';
//alert(GetStudentsURL);

function OnGetNodes(n) {

    //basically, these are the parameters to be passed to the server code [they MUST match exaclty, casing and all]
    var obj = {
        id: n.attr ? n.attr("id") : "0"
    }
    return Sys.Serialization.JavaScriptSerializer.serialize(obj);
}

function OnNodesRetrievedSuccess(data, textstatus, xhr) {

    //the ".d" is a security feature, annoying, but necessary
    return Sys.Serialization.JavaScriptSerializer.deserialize(data.d);
}

function OnNodesRetrievedError(xhr, textstatus, errorThrown) {
    alert(errorThrown);

    //document.location = "/MyErrorPage.aspx?errMsg="+errorThrown;
}
$(function () {
    $("#treeview").jstree({
        plugins: ["themes", "json_data", "checkbox", "crrm"],
        json_data: {
            ajax: {
                url: GetStudentsURL,
                async: true,
                contentType: "application/json; charset=utf-8",
                dataType: "text json",
                //dataType: "text json",
                type: "POST",
                data: function (n) {
                //alert(n);
                    return OnGetNodes(n);
                },
                success: function (data, textstatus, xhr) {
                    //alert(data);
                    //alert(textstatus);
                    //alert(xhr);
                    return OnNodesRetrievedSuccess(data, textstatus, xhr)
                },
                error: function (xhr, textstatus, errorThrown) {
                    //alert(errorThrown);
                    //alert(textstatus);
                    //alert(xhr);
                    OnNodesRetrievedError(xhr, textstatus, errorThrown)
                }
            }
        }
    })
});
    </script>
    <div id="treeview">
    </div>
</asp:Content>